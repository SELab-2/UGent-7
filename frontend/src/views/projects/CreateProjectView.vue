<script setup lang="ts">
import Calendar from 'primevue/calendar';
import BaseLayout from '@/components/layout/BaseLayout.vue';
import FileUpload from 'primevue/fileupload';
import Title from '@/components/layout/Title.vue';
import Tree from 'primevue/tree';
import { reactive, computed } from 'vue';
import { useRouter, useRoute } from 'vue-router';
import { useI18n } from 'vue-i18n';
import InputText from 'primevue/inputtext';
import Textarea from 'primevue/textarea';
import Button from 'primevue/button';
import InputNumber from 'primevue/inputnumber';
import InputSwitch from 'primevue/inputswitch';
import { Project } from '@/types/Projects';
import { useProject } from '@/composables/services/project.service';
import { required, helpers } from '@vuelidate/validators';
import { useVuelidate } from '@vuelidate/core';
import ErrorMessage from '@/components/forms/ErrorMessage.vue';

/* Composable injections */
const { t } = useI18n();
const { push } = useRouter();
const { params } = useRoute();

/* Service injection */
const { createProject } = useProject();

/* Form content */
const form = reactive({
    name: '',
    description: '',
    startDate: new Date(),
    deadline: new Date(),
    groupSize: 1,
    maxScore: 10,
    visibility: true,
    scoreVisibility: false,
    dockerScript: null,
    submissionStructure: null,
});

// Define validation rules for each form field
const rules = computed(() => {
    return {
        name: { required: helpers.withMessage(t('validations.required'), required) },
        startDate: { required: helpers.withMessage(t('validations.required'), required) },
        deadline: {
            required: helpers.withMessage(t('validations.required'), required),
            minDate: helpers.withMessage(t('validations.deadline'), (value: Date) => value > form.startDate),
        },
        groupSize: { required: helpers.withMessage(t('validations.required'), required) },
        maxScore: { required: helpers.withMessage(t('validations.required'), required) },
    };
});

// Function to handle the file upload of a docker script
const onDockerScriptUpload = (event: any) => {
    form.dockerScript = event.files[0];
};

// Function to handle the file upload of a zip file containing the submission structure
const onZipStructureUpload = (event: any) => {
    form.submissionStructure = event.files[0];
};


// useVuelidate function to perform form validation
const v$ = useVuelidate(rules, form);

const submitProject = async (): Promise<void> => {
    // Validate the form
    const result = await v$.value.$validate();

    // Only submit the form if the validation was successful
    if (result) {
        // Pass the project data to the service
        await createProject(
            new Project(
                '', // ID not needed for creation, will be generated by the backend
                form.name,
                form.description,
                form.visibility,
                false, // Default not archived
                false, // Default the groups are not locked
                form.startDate,
                form.deadline,
                form.maxScore,
                form.scoreVisibility,
                form.groupSize,
                form.submissionStructure
            ),
            params.courseId as string,
        );

        // Redirect to the dashboard overview
        push({ name: 'dashboard' });
    }
};
</script>

<template>
    <BaseLayout>
        <!-- Project form -->
        <form @submit.prevent="submitProject">
            <div class="grid fadein">
                <div class="col-12 md:col-10">
                    <!-- Create project heading -->
                    <Title class="mb-6">{{ t('views.projects.create') }}</Title>

                    <!-- Project name -->
                    <div class="mb-4">
                        <label for="projectName">{{ t('views.projects.name') }}</label>
                        <InputText id="projectName" v-model="form.name" />
                        <ErrorMessage :field="v$.name" />
                    </div>

                    <!-- Project description -->
                    <div class="mb-4">
                        <label for="projectDescription">{{ t('views.projects.description') }}</label>
                        <Textarea id="projectDescription" v-model="form.description" autoResize rows="5" cols="30" />
                    </div>

                    <!-- Start date of the project -->
                    <div class="mb-4">
                        <label for="projectStartDate">{{ t('views.projects.start_date') }}</label>
                        <Calendar
                            id="projectStartDate"
                            v-model="form.startDate"
                            dateFormat="dd-mm-yy"
                            :min-date="new Date()"
                            showIcon
                        />
                        <ErrorMessage :field="v$.startDate" />
                    </div>

                    <!-- Deadline of the project -->
                    <div class="mb-4">
                        <label for="projectDeadline">{{ t('views.projects.deadline') }}</label>
                        <Calendar
                            id="projectDeadline"
                            v-model="form.deadline"
                            dateFormat="dd-mm-yy"
                            :min-date="form.startDate"
                            showTime
                            hourFormat="24"
                            showIcon
                        />
                        <ErrorMessage :field="v$.deadline" />
                    </div>

                    <!-- Group size for the project -->
                    <div class="mb-4">
                        <label for="groupSize">{{ t('views.projects.group_size') }}</label>
                        <InputNumber id="groupSize" v-model="form.groupSize" :min="1" />
                        <ErrorMessage :field="v$.groupSize" />
                    </div>

                    <!-- Max score for the project -->
                    <div class="mb-4">
                        <label for="maxScore">{{ t('views.projects.max_score') }}</label>
                        <InputNumber id="maxScore" v-model="form.maxScore" :min="1" />
                        <ErrorMessage :field="v$.maxScore" />
                    </div>

                    <!-- Visibility of the project -->
                    <div class="mb-4">
                        <label for="visibility">{{ t('views.projects.visibility') }}</label>
                        <InputSwitch id="visibility" v-model="form.visibility" />
                    </div>

                    <!-- Score visibility of the project -->
                    <div class="mb-4">
                        <label for="scoreVisibility">{{ t('views.projects.score_visibility') }}</label>
                        <InputSwitch id="scoreVisibility" v-model="form.scoreVisibility" />
                    </div>

                    <!-- Submit button -->
                    <div class="flex justify-end">
                        <Button
                            :label="t('views.projects.create')"
                            type="submit"
                            icon="pi pi-check"
                            iconPos="right"
                            rounded
                        />
                    </div>
                </div>

                <div class="col-12 md:col-10">
                    <!-- Upload field for docker script -->
                    <div class="mt-7 mb-4">
                        <label for="dockerScript">{{ t('views.projects.docker_upload') }}</label>
                        <FileUpload id="dockerScript" mode="basic" accept=".sh" :multiple="false" @select="onDockerScriptUpload"/>
                    </div>

                    <!-- Upload field for a zip file that contains the submission structure -->
                    <div class="mb-4">
                        <label for="submissionStructure">{{ t('views.projects.submission_structure') }}</label>
                        <FileUpload id="submissionStructure" mode="basic" accept=".zip" :multiple="false" @select="onZipStructureUpload"/>
                    </div>
                </div>
            </div>
        </form>
    </BaseLayout>
</template>

<style scoped>
/* Flex column layout for label and input */
.mb-4 {
    display: flex;
    flex-direction: column;
}

/* Add margin between label and input */
label {
    margin-bottom: 0.5rem;
}

.grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

</style>
